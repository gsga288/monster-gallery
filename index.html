<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pet Card & Voice Chat</title>
  <script src="config.js"></script>
  <script src="index.html"></script>
  <style>
    /* Êï¥‰ΩìËÉåÊôØ */
    body, html {
      margin: 0; padding: 0;
      background: url('wonderland.png') no-repeat center center fixed;
      background-size: cover;
      font-family: sans-serif;
      color: #eee;
      display: flex; flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    /* Âç°ÁâåÊ†∑Âºè */
    .card {
      width: 80vw; max-width: 500px;
      background: rgba(34,34,34,0.9);
      border: 2px solid #444; border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.6);
      overflow: hidden; display: flex; flex-direction: column;
      margin-top: 20px;
    }
    .card-header {
      display: flex; justify-content: space-between;
      padding: 8px 12px; background: #333;
      border-bottom: 1px solid #444;
    }
    .pet-name { font-size: 1.2em; font-weight: bold; }
    .pet-rarity {
      font-size: 1.2em; padding: 2px 6px;
      border-radius: 4px; background: gold; color: #111;
    }
    .card-params {
      padding: 8px 12px; background: #2a2a2a;
      border-bottom: 1px solid #444;
      display: flex; justify-content: space-around;
      font-size: 0.95em;
    }
    .card-params div {
      display: flex; align-items: center; gap: 4px;
    }
    #media-container {
      width: 100%; height: 0; padding-bottom: 56.25%;
      position: relative; background: #000;
    }
    #media-container video {
      position: absolute; top:0; left:0;
      width:100%; height:100%; object-fit: cover;
    }
    .pet-desc {
      padding: 12px; background: #222;
      line-height: 1.4; font-size: 0.95em;
    }

    /* ËÅäÂ§©Âå∫ */
    #chat {
      width: 80vw; max-width: 500px;
      margin: 20px 0; padding: 10px;
      background: rgba(0,0,0,0.6); border-radius: 8px;
      display: flex; flex-direction: column;
    }
    #messages {
      flex:1; overflow-y: auto; max-height: 200px;
      margin-bottom: 10px;
    }
    .msg { margin: 4px 0; }
    .user { text-align: right; color: #8be9fd; }
    .bot  { text-align: left; color: #50fa7b; }
    .bot.error { color: #ff5555; }
    #controls {
      display: flex; gap: 8px;
    }
    #text-input {
      flex:1; padding:6px; font-size:1em;
      border-radius:4px; border:1px solid #555;
      background:#333; color:#eee;
    }
    #send-btn, #record-btn {
      padding:6px 12px; font-size:1em;
      border:none; border-radius:4px;
      background:#6272a4; color:#fff; cursor:pointer;
    }
    #record-btn.recording { background: #ff5555; }
  </style>
</head>
<body>

  <!-- ÂÆ†Áâ©Âç°Áâå -->
  <div class="card">
    <div class="card-header">
      <div class="pet-name" id="pet-name">‚Äî</div>
      <div class="pet-rarity" id="pet-rarity">‚Äî</div>
    </div>
    <div class="card-params">
      <div>‚ù§Ô∏è Heart Rate: <span id="heart">‚Äî</span></div>
      <div>‚úã Touch: <span id="touch">‚Äî</span></div>
      <div>üîä Sound Lvl: <span id="sound">‚Äî</span></div>
    </div>
    <div id="media-container"></div>
    <div class="pet-desc" id="pet-desc">‚Äî</div>
  </div>

  <!-- ËÅäÂ§©Âå∫ -->
  <div id="chat">
    <div id="messages"></div>
    <div id="controls">
      <button id="record-btn">üé§</button>
      <input id="text-input" placeholder="Type message‚Ä¶" />
      <button id="send-btn">Send</button>
    </div>
  </div>

  <script>
  // ‚Äî‚Äî ‰Ω†ÁöÑ OpenAI API Key ‚Äî‚Äî 
  const OPENAI_API_KEY = window.OPENAI_API_KEY;


  // ‚Äî‚Äî ÈöèÊú∫ÂèÇÊï∞ + ÂàÜÁ±ª + Âç°ÁâåÊ∏≤Êüì ‚Äî‚Äî 
  function randomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min;}
  function genParams(){return{heart:randomInt(60,100),touch:randomInt(0,50),sound:randomInt(0,120)};}
  function toBit(v,t){return v>t?'1':'0';}
  function categorize(p){return toBit(p.heart,80)+toBit(p.touch,25)+toBit(p.sound,80)+'0';}
  function getRarityText(code){
    const cnt = [...code].filter(c=>c==='1').length;
    const letter = ['D','C','B','A','S'][cnt];
    return 'Rarity: ' + letter;
  }
  const PET_MAP = {
    "0000":{src:"media/calm_friendly_relaxed_cautious/b.mp4",     name:"Gentle Jelly",    desc:"Floating calmly."},
    "0001":{src:"media/calm_friendly_relaxed_loving/b.mp4",      name:"Cuddly Whale",    desc:"Purring softly."},
    "0010":{src:"media/calm_friendly_alert_cautious/b.mp4",      name:"Alert Jelly",     desc:"Relaxed but watchful."},
    "0011":{src:"media/calm_friendly_alert_loving/b.mp4",       name:"Watchful Whale",  desc:"Seeks company."},
    "0100":{src:"media/calm_reserved_relaxed_cautious/b.mp4",    name:"Reserved Jelly",  desc:"Keeps distance."},
    "0101":{src:"media/calm_reserved_relaxed_loving/b.mp4",     name:"Hesitant Heart",  desc:"Tentative trust."},
    "0110":{src:"media/calm_reserved_alert_cautious/b.mp4",     name:"Guarded Jelly",   desc:"Vigilant calm."},
    "0111":{src:"media/calm_reserved_alert_loving/b.mp4",       name:"Torn Tide",       desc:"Caution + love."},
    "1000":{src:"media/excited_friendly_relaxed_cautious/b.mp4",name:"Bouncy Jelly",    desc:"Energetic bounce."},
    "1001":{src:"media/excited_friendly_relaxed_loving/b.mp4",  name:"Glowing Gem",     desc:"Radiant fondness."},
    "1010":{src:"media/excited_friendly_alert_cautious/b.mp4",  name:"Brave Guardian",  desc:"Excited protector."},
    "1011":{src:"media/excited_friendly_alert_loving/b.mp4",    name:"Fiery Embrace",   desc:"Passion + vigilance."},
    "1100":{src:"media/excited_reserved_relaxed_cautious/b.mp4",name:"Starlit Jelly",   desc:"Vibrant distance."},
    "1101":{src:"media/excited_reserved_relaxed_loving/b.mp4", name:"Shy Spark",       desc:"Quiet affection."},
    "1110":{src:"media/excited_reserved_alert_cautious/b.mp4", name:"Cautious Blaze",  desc:"Controlled blaze."},
    "1111":{src:"media/excited_reserved_alert_loving/b.mp4",   name:"Ultimate Bond",   desc:"Love & vigilance."}
  };
  function renderCard(){
    const p = genParams(), code = categorize(p), pet = PET_MAP[code];
    document.getElementById('heart').textContent   = p.heart;
    document.getElementById('touch').textContent   = p.touch;
    document.getElementById('sound').textContent   = p.sound;
    document.getElementById('pet-name').textContent   = pet.name;
    document.getElementById('pet-rarity').textContent = getRarityText(code);
    document.getElementById('pet-desc').textContent   = pet.desc;

    // ËßÜÈ¢ëÂä†ËΩΩÈ°∫Â∫èÔºöÂÖà preloadÔºåÂÜçËÆæÁΩÆ src
    const ctr = document.getElementById('media-container');
    ctr.innerHTML = '';
    const v = document.createElement('video');
    v.preload = 'auto';
    v.src      = pet.src;
    v.autoplay = true;
    v.loop     = true;
    v.muted    = true;
    v.playsInline = true;
    v.setAttribute('playsinline','');
    v.addEventListener('loadedmetadata', ()=> v.play().catch(()=>{}));
    ctr.appendChild(v);
  }
  renderCard();

  // ‚Äî‚Äî ËÅäÂ§©Ê°ÜÈÄªËæë ‚Äî‚Äî 
  const messagesDiv = document.getElementById('messages');
  let history = [{role:'system',content:'You are a friendly alien pet.'}];

  function appendMsg(txt, cls) {
    const d = document.createElement('div');
    d.className = `msg ${cls}`;
    d.textContent = txt;
    messagesDiv.appendChild(d);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  async function sendChat(text) {
    appendMsg(text, 'user');
    history.push({role:'user',content:text});
    try {
      const res = await fetch('https://api.openai.com/v1/chat/completions', {
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'Authorization':'Bearer '+OPENAI_API_KEY
        },
        body: JSON.stringify({
          model: 'gpt-4o',
          messages: history
        })
      });
      if (!res.ok) {
        const errText = await res.text();
        console.error('API Error:', res.status, errText);
        if (res.status === 429) {
          appendMsg('Error: Quota exhausted. Please check your billing plan.', 'bot error');
        } else {
          appendMsg(`Error ${res.status}`, 'bot error');
        }
        return;
      }
      const js = await res.json();
      const reply = js.choices[0].message.content;
      history.push({role:'assistant',content:reply});
      appendMsg(reply, 'bot');
      // ÊñáÂ≠óËΩ¨ËØ≠Èü≥
      const u = new SpeechSynthesisUtterance(reply);
      u.lang='en-US';
      speechSynthesis.speak(u);
    } catch (e) {
      console.error('Fetch exception', e);
      appendMsg('[Network Error]', 'bot error');
    }
  }

  document.getElementById('send-btn').onclick = () => {
    const inp = document.getElementById('text-input');
    const t = inp.value.trim();
    if (!t) return;
    inp.value = '';
    sendChat(t);
  };

  // ‚Äî‚Äî Whisper ÂΩïÈü≥ËΩ¨ÊñáÂ≠ó ‚Äî‚Äî 
  let recorder, chunks = [];
  const rb = document.getElementById('record-btn');
  rb.onclick = async () => {
    if (recorder && recorder.state==='recording') {
      recorder.stop();
      rb.classList.remove('recording');
    } else {
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      recorder = new MediaRecorder(stream);
      chunks = [];
      recorder.ondataavailable = e => chunks.push(e.data);
      recorder.onstop = async () => {
        const blob = new Blob(chunks,{type:'audio/webm'});
        const form = new FormData();
        form.append('file',blob,'voice.webm');
        form.append('model','whisper-1');
        try {
          const r = await fetch('https://api.openai.com/v1/audio/transcriptions', {
            method:'POST',
            headers:{ 'Authorization':'Bearer '+OPENAI_API_KEY },
            body: form
          });
          const j = await r.json();
          if (j.text) sendChat(j.text);
        } catch (err) {
          console.error('Whisper error',err);
          appendMsg('[Whisper Error]','bot error');
        }
      };
      recorder.start();
      rb.classList.add('recording');
    }
  };
  </script>
</body>
</html>
